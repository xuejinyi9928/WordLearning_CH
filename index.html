<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Word Learning</title>
    <script src="https://unpkg.com/jspsych@8.2.2"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-button-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-keyboard-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-audio-button-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-slider-response@2.1.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-fullscreen@2.0.0"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@2.1.0"></script>
    <link href="https://unpkg.com/jspsych@8.2.2/css/jspsych.css" rel="stylesheet" type="text/css" />

    <style>
        .no-cursor {
            cursor:none;
        }
    h1 {
        font-size: 36px;
    }
    p {
        font-size: 26px;
    }
    </style>
</head>
<body></body>

<script>
    var jsPsych = initJsPsych({
        on_finish: function() {
            jsPsych.data.addProperties({
                participant: id,
                version: version,
                wp_acc: wp_acc,
                wp_conf: wp_conf,
                wn_acc: wn_acc,
                wn_conf: wn_conf,
                pn_acc: pn_acc,
                pn_conf: pn_conf
            });
            var data = jsPsych.data.get().filter({task: 'response'});
            data.localSave('csv', `WL_${id}.csv`);
            alert('实验数据已保存，感谢您的参与！');
        }
    });
    var timeline = [];

    var id;
    do {
        id = prompt("请输入您的ID：", "");
    } while (!/^\d+$/.test(id));
    var version = String(2 - id % 2);
 
    var audio_list = [
        `audio/test.wav`,
        `audio/stream_a.wav`,
        `audio/stream_b.wav`,
        `audio/a1.wav`,
        `audio/a2.wav`,
        `audio/a3.wav`,
        `audio/a4.wav`,
        `audio/a5.wav`,
        `audio/a6.wav`,
        `audio/b1.wav`,
        `audio/b2.wav`,
        `audio/b3.wav`,
        `audio/b4.wav`,
        `audio/b5.wav`,
        `audio/b6.wav`,
        `audio/n1.wav`,
        `audio/n2.wav`,
        `audio/n3.wav`,
        `audio/n4.wav`,
        `audio/n5.wav`,
        `audio/n6.wav`
    ];
    var preload = {
        type: jsPsychPreload,
        audio: audio_list,
    };
    timeline.push(preload);

    var audio_test_instruction = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <h1>音频测试</h1>
            <br>
            <p>本实验需要播放音频，因此需要确保您的音频设备正常工作。</p>
            <p>请按下按钮播放测试音频，调节设备到合适的音量。</p>
        `,
        choices: ['<div style="font-size:26px;">测试音频</div>'],
    };
    timeline.push(audio_test_instruction);

    var audio_test = {
        type: jsPsychAudioButtonResponse,
        stimulus: 'audio/test.wav',
        choices: ['<div style="font-size:26px;">测试完毕</div>'],
        prompt: "<p>正在播放测试音频，请调节到合适音量后，点击上方测试完毕按钮。</p>",
    };
    timeline.push(audio_test);

    var fullscreen = {
        type: jsPsychFullscreen,
        fullscreen_mode: true,
        message: '<p>请按下按钮进入全屏模式以开始实验。</p>',
        button_label: '<div style="font-size:26px;">进入全屏</div>',
    };
    timeline.push(fullscreen);

    var instructions = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <h1>欢迎参加实验！</h1>
            <p>在这个实验中，您将听到一种<b>新的语言</b>，请您尽力去学习其中的<b>词汇</b>。</p>
            <p>实验分为两个部分：</p>
            <p>第一部分是<b>词汇学习</b>，请您专心听这种语言的录音，并努力记住其中的词汇。</p>
            <p>第二部分是<b>词汇测试</b>，您需要判断所听到的词汇是否是这个语言的词汇。</p>
            <p>词汇学习时间共3分钟，词汇测试共36题。</p>
        `,
        choices: ['<div style="font-size:26px;">开始学习</div>'],
    };
    timeline.push(instructions);
    
    var play_stream = {
        type: jsPsychAudioKeyboardResponse,
        stimulus: function () {
            if (version === '1') {
                return `audio/stream_a.wav`;
            } else {
                return `audio/stream_b.wav`;
            }
        },
        on_start: function() {
            document.body.classList.add('no-cursor');
        },
        choices: "NO_KEYS",
        trial_ends_after_audio: true,
        prompt: "<p>正在播放音频，请专心听并努力记住其中的词汇...</p>",
    };
    timeline.push(play_stream);

    var test_instructions = {
        type: jsPsychHtmlButtonResponse,
        stimulus: `
            <h1>恭喜你完成了词汇学习部分！</h1>
            <p>接下来将进行<b>词汇测试</b>。</p>
            <p>在这一部分中，您每次将先后听到<b>两个单词</b>。</p>
            <p>您需要判断其中哪一个更像是刚才学习的语言中的词汇。</p>
            <p>如果是第一个，请选择1；如果是第二个，请选择2。</p>
            <p>之后您还需对您的选择进行<b>信心评级</b>。</p>
            <p>测试共有36道题目，请您认真作答。</p>
        `,
        choices: ['<div style="font-size:26px;">开始测试</div>'],
        on_start: function() {
            document.body.classList.remove('no-cursor');
        },
    };
    timeline.push(test_instructions);

    if (version===1) {
        var test_stimuli = [
            {condition: 'word_phantom', word0: `audio/a1.wav`, word1: `audio/b1.wav`, answer: '0'},
            {condition: 'word_phantom', word0: `audio/a2.wav`, word1: `audio/b2.wav`, answer: '0'},
            {condition: 'word_phantom', word0: `audio/a3.wav`, word1: `audio/b3.wav`, answer: '0'},
            {condition: 'word_phantom', word0: `audio/a4.wav`, word1: `audio/b4.wav`, answer: '0'},
            {condition: 'word_phantom', word0: `audio/a5.wav`, word1: `audio/b5.wav`, answer: '0'},
            {condition: 'word_phantom', word0: `audio/a6.wav`, word1: `audio/b6.wav`, answer: '0'},
            {condition: 'word_phantom', word0: `audio/b1.wav`, word1: `audio/a1.wav`, answer: '1'},
            {condition: 'word_phantom', word0: `audio/b2.wav`, word1: `audio/a2.wav`, answer: '1'},
            {condition: 'word_phantom', word0: `audio/b3.wav`, word1: `audio/a3.wav`, answer: '1'},
            {condition: 'word_phantom', word0: `audio/b4.wav`, word1: `audio/a4.wav`, answer: '1'},
            {condition: 'word_phantom', word0: `audio/b5.wav`, word1: `audio/a5.wav`, answer: '1'},
            {condition: 'word_phantom', word0: `audio/b6.wav`, word1: `audio/a6.wav`, answer: '1'},
            {condition: 'word_nonword', word0: `audio/a1.wav`, word1: `audio/n1.wav`, answer: '0'},
            {condition: 'word_nonword', word0: `audio/a2.wav`, word1: `audio/n2.wav`, answer: '0'},
            {condition: 'word_nonword', word0: `audio/a3.wav`, word1: `audio/n3.wav`, answer: '0'},
            {condition: 'word_nonword', word0: `audio/a4.wav`, word1: `audio/n4.wav`, answer: '0'},
            {condition: 'word_nonword', word0: `audio/a5.wav`, word1: `audio/n5.wav`, answer: '0'},
            {condition: 'word_nonword', word0: `audio/a6.wav`, word1: `audio/n6.wav`, answer: '0'},
            {condition: 'word_nonword', word0: `audio/n1.wav`, word1: `audio/a1.wav`, answer: '1'},
            {condition: 'word_nonword', word0: `audio/n2.wav`, word1: `audio/a2.wav`, answer: '1'},
            {condition: 'word_nonword', word0: `audio/n3.wav`, word1: `audio/a3.wav`, answer: '1'},
            {condition: 'word_nonword', word0: `audio/n4.wav`, word1: `audio/a4.wav`, answer: '1'},
            {condition: 'word_nonword', word0: `audio/n5.wav`, word1: `audio/a5.wav`, answer: '1'},
            {condition: 'word_nonword', word0: `audio/n6.wav`, word1: `audio/a6.wav`, answer: '1'}, 
            {condition: 'phantom_nonword', word0: `audio/b1.wav`, word1: `audio/n1.wav`, answer: '0'},
            {condition: 'phantom_nonword', word0: `audio/b2.wav`, word1: `audio/n2.wav`, answer: '0'},
            {condition: 'phantom_nonword', word0: `audio/b3.wav`, word1: `audio/n3.wav`, answer: '0'},
            {condition: 'phantom_nonword', word0: `audio/b4.wav`, word1: `audio/n4.wav`, answer: '0'},
            {condition: 'phantom_nonword', word0: `audio/b5.wav`, word1: `audio/n5.wav`, answer: '0'},
            {condition: 'phantom_nonword', word0: `audio/b6.wav`, word1: `audio/n6.wav`, answer: '0'},
            {condition: 'phantom_nonword', word0: `audio/n1.wav`, word1: `audio/b1.wav`, answer: '1'},
            {condition: 'phantom_nonword', word0: `audio/n2.wav`, word1: `audio/b2.wav`, answer: '1'},
            {condition: 'phantom_nonword', word0: `audio/n3.wav`, word1: `audio/b3.wav`, answer: '1'},
            {condition: 'phantom_nonword', word0: `audio/n4.wav`, word1: `audio/b4.wav`, answer: '1'},
            {condition: 'phantom_nonword', word0: `audio/n5.wav`, word1: `audio/b5.wav`, answer: '1'},
            {condition: 'phantom_nonword', word0: `audio/n6.wav`, word1: `audio/b6.wav`, answer: '1'},
        ];
    } else {
        var test_stimuli = [
            {condition: 'word_phantom', word0: `audio/b1.wav`, word1: `audio/a1.wav`, answer: '0'},
            {condition: 'word_phantom', word0: `audio/b2.wav`, word1: `audio/a2.wav`, answer: '0'},
            {condition: 'word_phantom', word0: `audio/b3.wav`, word1: `audio/a3.wav`, answer: '0'},
            {condition: 'word_phantom', word0: `audio/b4.wav`, word1: `audio/a4.wav`, answer: '0'},
            {condition: 'word_phantom', word0: `audio/b5.wav`, word1: `audio/a5.wav`, answer: '0'},
            {condition: 'word_phantom', word0: `audio/b6.wav`, word1: `audio/a6.wav`, answer: '0'},
            {condition: 'word_phantom', word0: `audio/a1.wav`, word1: `audio/b1.wav`, answer: '1'},
            {condition: 'word_phantom', word0: `audio/a2.wav`, word1: `audio/b2.wav`, answer: '1'},
            {condition: 'word_phantom', word0: `audio/a3.wav`, word1: `audio/b3.wav`, answer: '1'},
            {condition: 'word_phantom', word0: `audio/a4.wav`, word1: `audio/b4.wav`, answer: '1'},
            {condition: 'word_phantom', word0: `audio/a5.wav`, word1: `audio/b5.wav`, answer: '1'},
            {condition: 'word_phantom', word0: `audio/a6.wav`, word1: `audio/b6.wav`, answer: '1'},
            {condition: 'word_nonword', word0: `audio/b1.wav`, word1: `audio/n1.wav`, answer: '0'},
            {condition: 'word_nonword', word0: `audio/b2.wav`, word1: `audio/n2.wav`, answer: '0'},
            {condition: 'word_nonword', word0: `audio/b3.wav`, word1: `audio/n3.wav`, answer: '0'},
            {condition: 'word_nonword', word0: `audio/b4.wav`, word1: `audio/n4.wav`, answer: '0'},
            {condition: 'word_nonword', word0: `audio/b5.wav`, word1: `audio/n5.wav`, answer: '0'},
            {condition: 'word_nonword', word0: `audio/b6.wav`, word1: `audio/n6.wav`, answer: '0'},
            {condition: 'word_nonword', word0: `audio/n1.wav`, word1: `audio/b1.wav`, answer: '1'},
            {condition: 'word_nonword', word0: `audio/n2.wav`, word1: `audio/b2.wav`, answer: '1'},
            {condition: 'word_nonword', word0: `audio/n3.wav`, word1: `audio/b3.wav`, answer: '1'},
            {condition: 'word_nonword', word0: `audio/n4.wav`, word1: `audio/b4.wav`, answer: '1'},
            {condition: 'word_nonword', word0: `audio/n5.wav`, word1: `audio/b5.wav`, answer: '1'},
            {condition: 'word_nonword', word0: `audio/n6.wav`, word1: `audio/b6.wav`, answer: '1'}, 
            {condition: 'phantom_nonword', word0: `audio/a1.wav`, word1: `audio/n1.wav`, answer: '0'},
            {condition: 'phantom_nonword', word0: `audio/a2.wav`, word1: `audio/n2.wav`, answer: '0'},
            {condition: 'phantom_nonword', word0: `audio/a3.wav`, word1: `audio/n3.wav`, answer: '0'},
            {condition: 'phantom_nonword', word0: `audio/a4.wav`, word1: `audio/n4.wav`, answer: '0'},
            {condition: 'phantom_nonword', word0: `audio/a5.wav`, word1: `audio/n5.wav`, answer: '0'},
            {condition: 'phantom_nonword', word0: `audio/a6.wav`, word1: `audio/n6.wav`, answer: '0'},
            {condition: 'phantom_nonword', word0: `audio/n1.wav`, word1: `audio/a1.wav`, answer: '1'},
            {condition: 'phantom_nonword', word0: `audio/n2.wav`, word1: `audio/a2.wav`, answer: '1'},
            {condition: 'phantom_nonword', word0: `audio/n3.wav`, word1: `audio/a3.wav`, answer: '1'},
            {condition: 'phantom_nonword', word0: `audio/n4.wav`, word1: `audio/a4.wav`, answer: '1'},
            {condition: 'phantom_nonword', word0: `audio/n5.wav`, word1: `audio/a5.wav`, answer: '1'},
            {condition: 'phantom_nonword', word0: `audio/n6.wav`, word1: `audio/a6.wav`, answer: '1'},
        ];
    }

    var play_word0 = {
        type: jsPsychAudioKeyboardResponse,
        stimulus: jsPsych.timelineVariable('word0'),
        choices: "NO_KEYS",
        trial_ends_after_audio: true,
        prompt: `<div style="font-size:36px;">1</div>`,
        on_start: function() {
            document.body.classList.add('no-cursor');
        },
    };
    var play_word1 = {
        type: jsPsychAudioKeyboardResponse,
        stimulus: jsPsych.timelineVariable('word1'),
        choices: "NO_KEYS",
        trial_ends_after_audio: true,
        prompt: `<div style="font-size:36px;">2</div>`,
        on_start: function() {
            document.body.classList.add('no-cursor');
        },
    };
    var get_response = {
        type: jsPsychHtmlButtonResponse,
        stimulus: '',
        choices: ['1', '2'],
        button_html: (choice) => `<button class="jspsych-btn" style="width: 100px; height: 100px; margin: 50px; font-size:36px; text-align: center;">${choice}</button>`,
        on_start: function() {
            document.body.classList.remove('no-cursor');
        },
    };
    var get_confidence = {
        type: jsPsychHtmlSliderResponse,
        stimulus: "<p>请对您的选择进行信心评级：</p>",
        labels: ['<p>完全不确定</p>', '<p>非常确定</p>'],
        min: 0,
        max: 100,
        slider_start: 50,
        step: 1,
        require_movement: true,
        button_label: '<div style="font-size:26px;">继续</div>',
        on_finish: function(data) {
            data.task = 'response';
            data.condition = jsPsych.evaluateTimelineVariable('condition');
            data.word0 = jsPsych.evaluateTimelineVariable('word0');
            data.word1 = jsPsych.evaluateTimelineVariable('word1');
            data.correct_answer = jsPsych.evaluateTimelineVariable('answer');
            data.answer = jsPsych.data.get().last(2).values()[0].response;
            data.correct = (data.answer == data.correct_answer);
            data.confidence = data.response;
            
        },
    }
    var blank = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '',
        choices: "NO_KEYS",
        trial_duration: 500,
        on_start: function() {
            document.body.classList.add('no-cursor');
        },
    };
    var test_procedure = {
        timeline: [play_word0, blank, play_word1, blank, get_response, get_confidence, blank],
        timeline_variables: test_stimuli,
        randomize_order: true,
    };
    timeline.push(test_procedure);

    var wp_acc = 0;
    var wp_conf = 0;
    var wn_acc = 0;
    var wn_conf = 0;
    var pn_acc = 0;
    var pn_conf = 0;

    var debrief = {
        type: jsPsychHtmlButtonResponse,
        stimulus: function() {
            var data = jsPsych.data.get().filter({task: 'response'});
            var correct_data = data.filter({correct: true});
            wp_acc = correct_data.filter({condition: 'word_phantom'}).count() / data.filter({condition: 'word_phantom'}).count();
            wp_conf = correct_data.filter({condition: 'word_phantom'}).select('confidence').mean();
            wn_acc = correct_data.filter({condition: 'word_nonword'}).count() / data.filter({condition: 'word_nonword'}).count();
            wn_conf = correct_data.filter({condition: 'word_nonword'}).select('confidence').mean();
            pn_acc = correct_data.filter({condition: 'phantom_nonword'}).count() / data.filter({condition: 'phantom_nonword'}).count();
            pn_conf = correct_data.filter({condition: 'phantom_nonword'}).select('confidence').mean();
            return `
                <h1>实验结束！</h1>
                <p>感谢您的参与！</p>
                <p>您的测试结果如下：</p>
                <p>词汇-幻词：准确率 ${(wp_acc*100).toFixed(2)}%，平均信心 ${wp_conf.toFixed(2)}</p>
                <p>词汇-非词：准确率 ${(wn_acc*100).toFixed(2)}%，平均信心 ${wn_conf.toFixed(2)}</p>
                <p>幻词-非词：准确率 ${(pn_acc*100).toFixed(2)}%，平均信心 ${pn_conf.toFixed(2)}</p>
            `;
        },
        choices: ['<div style="font-size:26px;">退出全屏并保存数据</div>'],
        on_start: function() {
            document.body.classList.remove('no-cursor');
        },
    };
    timeline.push(debrief);

    var exit_fullscreen = {
        type: jsPsychFullscreen,
        fullscreen_mode: false,
    };
    timeline.push(exit_fullscreen);

    jsPsych.run(timeline);
</script>
